import datetime
from io import TextIOWrapper
import logging
import os
import platform
from pathlib import Path

import hikari


async def backup_database(dsn: str) -> hikari.File:
    """Attempts to back up the database via pg_dump into the db_backup directory"""
    logging.info("Performing daily database backup...")

    username: str = dsn.split(":")[1][2:]
    password: str = dsn.split(":")[2].split("@")[0]
    hostname: str = dsn.split(":")[2].split("@")[1]
    port: str = dsn.split(":")[3].split("/")[0]
    db_name: str = dsn.split(":")[3].split("/")[1]

    filepath: str = os.path.dirname(os.path.realpath(__file__))

    if not os.path.isdir(os.path.join(filepath, "db_backup")):
        os.mkdir(os.path.join(filepath, "db_backup"))

    def generate_pgpass(filepath: str) -> None:
        pgpass_contents = f"#Automatically generated by Sned-Bot\n{hostname}:{port}:{db_name}:{username}:{password}"
        file: TextIOWrapper = open(filepath, "w")
        file.write(pgpass_contents)
        file.close()

    if platform.system() == "Windows":
        if not os.path.isfile(os.path.expandvars(r"%APPDATA%\postgresql\pgpass.conf")):
            generate_pgpass(os.path.expandvars(r"%APPDATA%\postgresql\pgpass.conf"))
    else:
        if not os.path.isfile(os.path.join(Path.home(), ".pgpass")):
            generate_pgpass(os.path.join(Path.home(), ".pgpass"))
            os.system("chmod 600 ~/.pgpass")

    now = datetime.datetime.now(datetime.timezone.utc)

    filename: str = f"{now.year}-{now.month}-{now.day}_{now.hour}_{now.minute}_{now.second}.sql"
    backup_path: str = os.path.join(filepath, "db_backup", filename)

    os.system(f"pg_dump -c -U {username} -d {db_name} -h {hostname} -p {port} -w > {backup_path}")

    logging.info("Database backup complete!")
    return hikari.File(backup_path)
